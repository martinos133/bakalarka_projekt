// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  USER
}

enum AdvertisementStatus {
  PENDING
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum AdvertisementType {
  SERVICE
  RENTAL
}

enum CategoryStatus {
  ACTIVE
  DRAFT
  INACTIVE
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String?
  lastName      String?
  phone         String?
  dateOfBirth   DateTime?
  gender        Gender?
  isCompany     Boolean   @default(false)
  companyName   String?
  companyId     String?   // IČO
  companyTaxId  String?   // DIČ
  address       String?
  city          String?
  postalCode    String?
  country       String?
  role          UserRole  @default(USER)
  banned        Boolean   @default(false)
  bannedUntil   DateTime?
  banReason     String?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  advertisements Advertisement[]
  paymentsReceived Payment[] @relation("Owner")
  paymentsMade Payment[]     @relation("Renter")
  reports        Report[]    @relation("Reports")
  messagesReceived Message[] @relation("MessageRecipient")
  messagesSent   Message[]   @relation("MessageSender")
  
  @@index([banned])
  @@index([bannedUntil])
  @@index([isCompany])
}

model Category {
  id            String         @id @default(uuid())
  name          String         @unique
  slug          String         @unique
  description   String?        @db.Text
  icon          String?
  color         String?
  image         String?        // URL alebo base64 obrázka
  imageAlt      String?        // Alt text pre obrázok (SEO)
  banner        String?        // Banner obrázok pre stránku kategórie
  bannerAlt     String?        // Alt text pre banner (SEO)
  metaTitle     String?        // SEO meta title
  metaDescription String?      @db.Text // SEO meta description
  metaKeywords  String?        // SEO meta keywords (oddelené čiarkou)
  ogImage       String?        // Open Graph obrázok (voliteľné)
  status        CategoryStatus @default(ACTIVE)
  parentId      String?
  order         Int            @default(0)
  parent        Category?      @relation("CategoryChildren", fields: [parentId], references: [id], onDelete: Cascade)
  children      Category[]     @relation("CategoryChildren")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  advertisements Advertisement[]
  filters       Filter[]
  
  @@index([slug])
  @@index([status])
  @@index([parentId])
  @@index([order])
}

enum FilterType {
  TEXT
  NUMBER
  SELECT
  MULTISELECT
  BOOLEAN
  DATE
  RANGE
}

model Filter {
  id          String     @id @default(uuid())
  name        String
  slug        String
  type        FilterType
  categoryId  String
  category    Category   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  description String?    @db.Text
  options     String[]   // Pre SELECT a MULTISELECT typy
  isRequired  Boolean    @default(false)
  isActive    Boolean    @default(true)
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  
  @@unique([categoryId, slug])
  @@index([categoryId])
  @@index([isActive])
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

model Advertisement {
  id          String             @id @default(uuid())
  title       String
  description String             @db.Text
  price       Float?
  status      AdvertisementStatus @default(PENDING)
  type        AdvertisementType  @default(SERVICE)
  categoryId  String?
  category    Category?          @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  location    String?
  postalCode String?
  images      String[]
  // Service-specific fields
  pricingType String?            // 'FIXED', 'HOURLY', 'DAILY', 'PACKAGE'
  hourlyRate  Float?
  dailyRate   Float?
  packages    Json?              // Array of package objects with name, description, price, deliveryTime
  deliveryTime String?           // e.g., "3-5 dní", "1 týždeň"
  revisions   String?            // e.g., "Neobmedzené", "3 revízie"
  features    String[]           // Array of features/included items
  faq         Json?              // Array of FAQ objects with question and answer
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  userId      String
  user        User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments    Payment[]          @relation("AdvertisementOwner")
  reports     Report[]
  messages   Message[]
  
  @@index([userId])
  @@index([status])
  @@index([categoryId])
  @@index([type])
}

model Payment {
  id              String         @id @default(uuid())
  advertisementId String
  advertisement   Advertisement  @relation("AdvertisementOwner", fields: [advertisementId], references: [id], onDelete: Cascade)
  renterId        String
  renter          User           @relation("Renter", fields: [renterId], references: [id], onDelete: Cascade)
  ownerId         String
  owner           User           @relation("Owner", fields: [ownerId], references: [id], onDelete: Cascade)
  amount          Float
  status          PaymentStatus  @default(PENDING)
  paymentDate     DateTime?
  startDate       DateTime?
  endDate         DateTime?
  notes           String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([advertisementId])
  @@index([renterId])
  @@index([ownerId])
  @@index([status])
}

enum ReportStatus {
  PENDING
  RESOLVED
  DISMISSED
}

enum ReportReason {
  SPAM
  INAPPROPRIATE
  FAKE
  SCAM
  COPYRIGHT
  OTHER
}

model Report {
  id              String         @id @default(uuid())
  advertisementId String
  advertisement   Advertisement  @relation(fields: [advertisementId], references: [id], onDelete: Cascade)
  reporterId      String
  reporter        User           @relation("Reports", fields: [reporterId], references: [id], onDelete: Cascade)
  reason          ReportReason
  description     String?        @db.Text
  status          ReportStatus   @default(PENDING)
  resolvedBy      String?        // Admin ID
  resolvedAt      DateTime?
  resolutionNote  String?        @db.Text
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  
  @@index([advertisementId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
}

enum MessageType {
  INQUIRY           // Správa od záujemcu o inzerát
  SYSTEM            // Systémová správa
  BAN_NOTIFICATION  // Notifikácia o banu
  VIOLATION         // Porušenie pravidiel
  AD_APPROVED       // Inzerát schválený
  AD_REJECTED       // Inzerát zamietnutý
}

enum MessageStatus {
  UNREAD
  READ
  ARCHIVED
}

model Message {
  id              String        @id @default(uuid())
  type            MessageType
  subject         String
  content         String        @db.Text
  status          MessageStatus @default(UNREAD)
  recipientId     String
  recipient       User          @relation("MessageRecipient", fields: [recipientId], references: [id], onDelete: Cascade)
  senderId        String?
  sender          User?          @relation("MessageSender", fields: [senderId], references: [id], onDelete: SetNull)
  advertisementId String?
  advertisement   Advertisement? @relation(fields: [advertisementId], references: [id], onDelete: SetNull)
  metadata        Json?         // Ďalšie informácie (napr. dôvod banu, dátum banu, atď.)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  readAt          DateTime?
  
  @@index([recipientId])
  @@index([senderId])
  @@index([advertisementId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
}

// Monitoring kliknutí – ženy, muži, firmy, fyzické osoby
model ClickEvent {
  id          String   @id @default(uuid())
  userId      String?   // ak je používateľ prihlásený
  sessionId   String?   // pre anonymné návštevy
  gender      Gender?   // MALE, FEMALE, OTHER
  isCompany   Boolean?  // true = firma, false = fyzická osoba
  eventType   String    @default("CLICK") // CLICK, VIEW, ...
  targetType  String?   // AD, CATEGORY, ...
  targetId    String?
  createdAt   DateTime @default(now())

  @@index([userId])
  @@index([gender])
  @@index([isCompany])
  @@index([createdAt])
  @@index([eventType])
}
